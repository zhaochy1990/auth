services:
  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      ACCEPT_EULA: Y
      MSSQL_SA_PASSWORD: TestPassword1!
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P TestPassword1! -C -Q "SELECT 1"
      interval: 10s
      timeout: 5s
      retries: 10

  auth:
    build: .
    ports:
      - "3001:3000"
    volumes:
      - ./keys:/app/keys:ro
    environment:
      DATABASE_URL: "Server=mssql,1433;User Id=sa;Password=TestPassword1!;Database=auth_db;TrustServerCertificate=true"
      SERVER_HOST: "0.0.0.0"
      SERVER_PORT: "3000"
      JWT_PRIVATE_KEY_PATH: "./keys/private.pem"
      JWT_PUBLIC_KEY_PATH: "./keys/public.pem"
      CORS_ALLOWED_ORIGINS: "http://localhost:5173"
      RUST_LOG: "auth_service=debug"
    depends_on:
      mssql:
        condition: service_healthy
